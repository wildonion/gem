


# ü§è Conse Backend Rust Services

Conse is an AI based Crypto Game Event Manager Platform on top of [coiniXerr](https://github.com/wildonion/uniXerr/tree/master/infra/valhalla/coiniXerr) and Solana blockchain which uses: 
- behavioural graph virtual machine (GVM) built on top of each event's `phases` field inside the game for each player to suggests them the tips and tricks for a new game and reward them based on their game scores using an AI based coin generation model in which players get rewarded based on their scores and positions then update the balance field of the user based on those attributes.
- match making rating (**MMR**) graph engine which is a weighted tree that suggests players events and other games based on their past experiences, scores and earned tokens during the game.
- p2p order book in which players can sell their minted roles based on highest or lowest order setup.
- event collaboration queue (**ECQ**) system in which admins can share their registered events and collaborate with other admins.

<p align="center">
    <img width=350 height=350 src="https://github.com/wildonion/gem/blob/master/assets/conse.png"
</p>

```bash
# panel dev username/password              : devdevy/d3v@%$^$3hjsD
# panel admin username/password            : adminy/4dmin@%$^$3hjsD
# postgres adminer username/password/server: postgres/geDteDd0Ltg2135FJYQ6rjNYHYkGQa70/postgres
ü•õ WEBSOCKET PUSH NOTIFICATION ROUTE ==> wss://notif.panel.conse.app/subscribe/
üåç MAIN SITE ==> https://conse.app/
üë®üèª‚Äç‚öñÔ∏è ADMIN PANEL ==> https://panel.conse.app/
üõ§Ô∏è ADMIN/DEV API ROUTE ==> https://api.panel.conse.app/
üó∫Ô∏è MAIN API ROUTE ==> https://api.mafia.conse.app/
üì° SWAGGER DOC ==> https://api.panel.conse.app/swagger/
üõ¢Ô∏è ADMINER PANEL ==> https://adminer.conse.app
üéôÔ∏è HOSTED ON ==> Digitalocean
üöâ TLPs ==> https://github.com/wildonion/gem/wiki/TLPs
ü•™ GEM ERD SCHEMAS ==> https://github.com/wildonion/gem/wiki/Gem-ERD-Schemas
```

## üç© V0.1.3 Features

* **ü¶Ä Rust flows in you üåä**: write codes that are the matter-of-future flows!

* **‚òï sit-back-and-drink-your-coffee** scripts do deploy the project on VPS!

* ü¶æ functional, macro, MVC and ACL based design pattern server APIs

* ‚ò¢Ô∏è better error handling using **match** and **Option** syntax

* ‚ùå custom error type (`PanelError`) to handle all possible server (actixweb and websocket) and storage (redis, redis async and diesel) IO errors in conse panel.
 
* üßëüèª‚Äçüíº game managers (admins) can define score based twitter tasks for users (players), reveal role, collaborate with other admins and share their registered events using conse **ECQ** (Event Collaboration Queue) system and advertise their events via SMS inside the panel  

* üç™ **cookie** and **JWT** based authentication strategy

* üîê **Argon2** as the **KDF** used for password hasing

* ü•ù server health-check APIs (check-token, health and logout)

* üçÖ catchup discord ChatGPT bot for channel messages summarization 

* üì° **swagger** docs using **utoipa openapi** for all admin, dev and user panel APIs supports all possible server's responses 

* üéí supports **postgres**, **mongodb** and **redis** as the app storage  

* üõéÔ∏è **actix web** and **hyper** based HTTP servers and handling push notif subscriptions

* üì£ **redis** based pubsub streaming channel to publish and subscribe to the revealed roles, **ECQ** (Event Collaboration Queue), **MMR** (Match Making Rating) and new minted role order for trading topics

* üíæ **redis** http response caching to avoid high latencies cause I believe reading from RAM is much faster than HardDisk.   

* üéØ **actix ws** server for streaming over redis subscribed topics  

### üóÉÔ∏è Directory and Structure Explained

> Note that to use dev and admin panel APIs Remember to run conse mafia hyper server first.

* `core`: hyper, actix web HTTP and actix WS servers.
    * `bots`: serenity catchup discord and twiscord bots.
    * `panel`: dev and admin panel actix web and actix WS server.
    * `www`: dev and admin panel app written in yew.
    * `mafia`: mafia game APIs
        * `controllers`: in-game async controllers related to hyper server.
        * `routers`: in-game API routers related to hyper server.
        * `schemas`: in-game mongodb schemas related to hyper server.
* `infra`: all infrastructure and devops configs.
* `errors`: gem possible errors handler
* `jobs`: gem crontab jobs
* `logs`: gem log files generated by discord bot service, conse panel and other parts of the app.
* `migrations`: diesel postgres sql files
* `scripts`: deployment scripts
* `test`: gem test codes

**NOTE**: All `mafia`, `panel` and `bots` services inside `core` are just different binaries which are sharing a same `Cargo.toml` setup.

## üõ†Ô∏è Development Setup

> Before developing, read the following notes: 

- **NOTE**: makre sure that you've installed the following packages on **MacOS M1**:
```bash
brew install openjdk
brew install pkg-config
brew install openssl
brew install diesel
brew link --force openssl
brew install libpq && brew link --force libpq
brew install graphviz
cargo clean
```

- **NOTE**: **Regards to conse panel actix APIs**, if you want to extend the last table fields first update its `up.sql` file then run ```diesel migration redo``` and finally ```diesel migration run```, to regenerate all tables run ```diesel migration redo -n 3``` which **3** refers to the number of tables we've created so far.

- **NOTE**: **Regards to conse panel actix APIs**, before migrating any table, make sure that you've an already setup database using ```diesel setup && diesel migration run``` command.

- **NOTE**: **Regards to conse panel actix APIs**, use ```diesel migration generate <MIGRAION_NAME>``` to create the migration file containing the postgres table setup, ```diesel migration redo``` to drop the table and ```diesel migration run``` to apply all migration tables to the database after submitting changes to the sql fiels.

- **NOTE**: **Regards to conse mafia hyper APIs**, to update a user access level to `dev` first do a signup for the user using `/auth/signup` API then run the mafia binary server like so: `./mafia dev 0` or `cargo run --bin mafia dev 0` finally login with that user to register a new god for the game.

- **NOTE**: **Regards to conse panel actix APIs**, in development environment remember to fill the `OPENAI_KEY` and `DISCORD_TOKEN` vars inside the `.env` with appropriate values, but for production deployment remove these fields from `.env`

```bash
# üß™ Test Conse Hyper Server
cargo test --bin mafia
# üèÉ Run Conse Hyper Server
cargo run --bin mafia #---> cargo build --bin mafia --release
# üèÉüèΩ‚Äç‚ôÄÔ∏è Run Conse Actix Panel Server
cargo run --bin panel #---> cargo build --bin panel --release
# üèÉüèª‚Äç‚ôÄÔ∏è Run Conse Discord Bot Server
cargo run --bin catchup-bot #---> cargo build --bin catchup-bot --release
# üèÉüèª‚Äç‚ôÄÔ∏è Run Conse Twiscord Bot Server
cargo run --bin twiscord #---> cargo build --bin twiscord --release
# üèÉüèø Run Conse Argon2 Test Codes
cargo run --bin argon2test
```
    
## üöÄ Production Setup

> Before going for production, read the following notes: 

- **NOTE**: **Regards to conse panel actix APIs**, there is a env var called `THIRD_PARY_TWITTER_BOT_ENDPOINT` which can be set to an external twitter bot server endpoint to send requests for user task verification, if you want to use a third party bot remember to pass the endpoint to the instance of the `Twitter` struct like `let bot = Twitter::new(Some(bot_endpoint));`.

- **NOTE**: **Regards to conse panel actix APIs**, currently the `/bot/check-users-tasks` API will be called every day at **7 AM** via a setup crontab inside the `jobs` folder to avoid twitter rate limit issue, if you want to change the cron just run `crontab -e` command inside the `jobs` folder and edit the related cron file.

- **NOTE**: **Regards to conse panel actix APIs**, in order to use twitter APIs you must have a paid developer account and you must use keys and tokens from a twitter developer App that is attached to a project also you can add new keys in `twitter-accounts.json` by calling the `/admin/add-twitter-accounts` API.

- **NOTE**: **Regards to conse panel actix APIs**, to generate a new password for admin and dev users just edit the `argon2test.rs` code inside the `tests` folder then run ```cargo run --bin argon2test``` to generate those passwords finally update the `up.sql` inside the `migrations/2023-05-22-184005_users` folder to insert a new admin and dev user info into the table when you run ```diesel migration run```. 

- **NOTE**: **Regards to conse mafia hyper APIs**, to update a user access level of the conse mafia hyper server to dev, first signup the user using `/auth/signup` API then update the `access_level` field of the user to `0` manually inside the db in `mongodb` container using `portrainer` finally login with dev user to register a new god for the game.

- **NOTE**: **Regards to conse mafia hyper APIs**, the default `dev` and `conse` user passwords are `dev@1234%` and `conse@1234` respectively which will be imported to the mongodb automatically by running the `./redeploy.sh` script, also we can run the `./mafia dev 0` binary inside the VPS to update the access level of a user to dev, finally we can register a new god or admin for the mafia game APIs using the dev user token.

- **NOTE**: to access the `mongodb` container shell, login to the `portrainer` then fireup the `mongodb` container CMD and run ```mongosh``` or you can go inside using ```sudo docker exec -it mongodb mongosh``` command.

- **NOTE**: after updating application's `Dockerfile` files, we should rebuild our container images by running ```./redeploy.sh``` script again.

- **NOTE**: all docker container the mounted volumes are inside `infra/data` folder.

- **NOTE**: in order to use docker containers inside another one by its DNS name, all of them must be inside the same network bridge like if we want to use the mongodb container inside the panel container they must be in the same network called `gem`. 

- **NOTE**: make sure that you have the `conse.app` domain enabled and is pointing to the machine where the `gem` codes is hosted on.

- **NOTE**: rerun the `renew.sh` on every changes to the nginx config file like hosting new codes, services or adding a new domain to the VPS.

- **NOTE**: for every new (sub)domain inside the VPS there must be a new config file and a new ssl certificate inside the `infra/docker/nginx` folder related to that (sub)domain name.

- **NOTE**: registered (sub)domain records in DNS panel must be:
```bash
conse.app #---> this main domain is related to the home of the app
api.mafia.conse.app #---> points to the conse mafia hyper APIs
api.panel.conse.app #----> points to the conse actix APIs
panel.conse.app #---> points to the panel UI
notif.panel.conse.app #---> points to the websocket push notification server APIs
adminer.conse.app #---> points to the adminer UI
checkpswd.conse.app #---> points to a very simple password checker fastapi server
```
- **NOTE**: to serve static files using nginx just make sure you copied the `build-{PROJECT-NAME}` folder of JS projects into `infra/docker/nginx/build` folder.   

- **NOTE**: multiple domains can point to a same VPS which their ssl-s and routes can be setup by nginx also multiple (sub)domains of different domains can point to multiple VPS-es which can be setup inside the DNS panel of those domains like the following:

**DNS records of conse.app domain**

```
Type	    Hostname	               Value	          TTL (seconds)	
A	    conse.app              directs to 64.226.71.201	     3600
A	    api.mafia.conse.app   	   directs to 68.183.137.151     3600 
A	    panel.conse.app    	   directs to 68.183.201.134     3600 
```
**DNS records of wildonion.io domain**

```
Type	    Hostname	               Value	          TTL (seconds)	
A	    wildonion.io           directs to 64.226.71.201	     3600
A	    api.wildonion.app      directs to 68.183.137.154     3600 
A	    admin.wildonion.app    directs to 68.183.201.129     3600 
```
in the above records `wildonion.io` and `conse.app` are pointing to a same VPS but their (sub)domains are pointing to different VPS-es. 

```bash
# -----------------------
# ---- read/write access
sudo chown -R root:root . && sudo chmod -R 777 .
sudo chmod +x /root && sudo chown -R root:root /root && sudo chmod -R 777 /root
cd scripts
# ---------------
# ---- setup VPS
./setup.sh
# ---------------
# ---- deploy containers
./redeploy.sh
# ---------------
# ---- renew nginx 
./renew.sh

# OR use make

make setup 
make redeploy
make renew
```
    
## ü™ü Schemas and ERDs

> Note that to regenerate the ERD from the postgres database just run ```sqlant postgresql://postgres:<PASSWORD>@localhost/conse > infra/panel.uml && java -jar infra/plantuml.jar infra/panel.uml```.

### ü•™ Conse Panel Postgres ERD Schema

<p align="center">
    <img src="https://github.com/wildonion/gem/blob/master/infra/panel.png">
</p>

### üç¢ Conse Mongodb ERD Schema

<p align="center">
    <img src="https://github.com/wildonion/gem/blob/master/infra/conse.schema.PNG">
</p>

### üñºÔ∏è [Conse Panel](https://github.com/wildonion/gem/tree/master/core/panel) Architecture Diagram

<p align="center">
    <img src="https://github.com/wildonion/gem/blob/master/infra/arch.jpg">
</p>

### ü•ß [Twiscord](https://github.com/wildonion/gem/tree/master/core/bot/twiscord) Architecture Diagram

<p align="center">
    <img src="https://github.com/wildonion/gem/blob/master/infra/rediscord.png">
</p>

## üßê WrapUps 

* to see a full list of conse mafia hyper server, import the `gem.http.api.json` into the postman which is inisde the `infra` folder, also for the conse panel actix APIs there is swagger UI which can be loaded through the `https://api.panel.conse.app/swagger/` address to see all available APIs.

> **Regards to conse panel actix APIs**:

* to all gorgeous admins, the `role` field must be **uppercase** and it's default value when it's not passed is **Dev**.

* the generated cookie inside the response of the conse panel admin and user login APIs is in form `<JWT>::<SHA256_OF_LOGIN_TIME>`.

* admin and user login APIs of conse panel returns a response which contains the generated cookie for the user in which we can use the first part of `::` sign, as the **JWT** to send authorized requests in postman and swagger UI. 

* all conse panel APIs except admin and user login, health check and logout APIs need a **JWT** inside the Authorization header or the cookie variable in the their request objects also the **JWT** can be set in their swagger UI page using the `Authorize üîí` button. 

* in order to reveal the roles of an event, admin **JWT** token generated by the conse mafia hyper server must be passed to the request header of the `/admin/notif/register/reveal-role/{event_objectid}` API inside the panel server, also same as for the dev APIs including `/get/admin/{admin_id}/data` and `/get/user/{user_id}/data`.

* conse clients can subscribes to the fired or emitted events and topics like role reveal, ecq, new tasks and task verification logs and see notifications coming from redis docker server by listening to websocket packets comming from actix websocket server.

* pubsub new task, twitter task verification response, twitter bot response, **ECQ**, **MMR** and reveal role topics are `ecq-{event_objectid}`, `mmr-{event_objectid}`, `reveal-role-{event_objectid}` respectively.   

* push notification routes for **ECQ**, **MMR** and reveal role topics are `wss://notif.panel.conse.app/subscribe/ecq-{event_objectid}`, `wss://notif.panel.conse.app/subscribe/mmr-{event_objectid}`, `wss://notif.panel.conse.app/subscribe/{user_objectid}/reveal-role-{event_objectid}` respectively and in order to receive realtime notifs data users must use `/join` command to join the ws channel and create a session after they gets connected.

* twitter task names defined by admins, must be prefixed with `twitter-*` and are twitter activities such as `tweet` which can be a specific content or the generated code by the backend, `like`, `hashtag` and `retweet` that must be done to reward users based on the score of each task.

* admins can define multiple twitter tasks in the same activity, all tasks will be separated by a random chars like `*-<RANDOM_CHARS>` so the final task name will be `twitter-username-iYTC^`.

* every day at **7 AM** all the users tasks will be checked automatically using a cronjob to see that the user is still verified or not, this will be done by checking all the records of the `users_tasks` table inside the `/check-users-tasks` API. 

* once the user gets loggedin, first the `/user/verify-twitter-account/{account_name}` API must be called to verify and update the twitter username inside the db then then we must compel the user to tweet the activity code which is inside the user data response.

## üöß WIPs

* admin SMS panel to advertise the event

* god and dev panel app using `yew`

* macros inside the `core/panel/misc.rs` and a proc macro attribute like `#[passport(access=2)]` to put on top of the admin, user and dev APIs, struct and their fields

* behavioural graph virtual machine (gvm) using `Rc` and `RefCell` of each player collected by the history of each event's `phases` field, event collaboration queue (ecq), order book and match making rating (mmr) engines  

* redis pubsub streaming structure for publishing new minted role order for trading, ecq (for registered events) and mmr (for event suggestion to players) topics inside `core/panel/events/redis` folder along with their actor notifs structure inside `core/panel/events/ws` folder

* publish docker containers to docker hub also add CI/CD setup in digitalocean

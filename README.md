

<img src="https://github.com/wildonion/gem/blob/master/assets/conse.png" width="150"/>

# üõû Rust Backend and Engines

Conse is a crypto based friendly gathering board **Game Event Manager**, advertising platform (**advieh**), gallery based NFT Marketplace on top of **Polygon** and **Patel Near-duplicate image detection APIs** with the following engines as its core backend: 
- **pubsub** pattern to reveal player in-game roles using the redis publisher and subscriber and websocket server to notify players of new roles once the server subscribed to the revealed roles topic.
- event collaboration queue (**ECQ**) system in which admins or game managers can share their registered events and collaborate with other admins.
- behavioural graph virtual machine (**[GVM](https://github.com/wildonion/gvm/)**) built on top of each event's `phases` field inside the game for each player to match them for new game and rank them based on their in-game statuses, the match making rating or ranking (**MMR**) engine, on the other hand is is a weighted tree based suggestion engine that suggests players, events and other games and players based on their ranks earned using **GVM** during the game.

## üöü Infra Routes and APIs

```bash
# conse panel dev username/password              : devdevy/d3v@%$^$3hjsD
# conse panel admin username/password            : adminy/4dmin@%$^$3hjsD
# postgres adminer username/password/server      : postgres/geDteDd0Ltg2135FJYQ6rjNYHYkGQa70/postgres
ü•õ WEBSOCKET PUSH NOTIFICATION ROUTE ==> wss://notif.panel.conse.app/subscribe/
üåç MAIN SITE ==> https://conse.app/
üë®üèª‚Äç‚öñÔ∏è ADMIN PANEL ==> https://panel.conse.app/
üõ§Ô∏è ADMIN/DEV API ROUTE WITH POSTGRES DB STORAGE ==> https://api.panel.conse.app/
üõ£ ADMIN/DEV API ROUTE WITH MONGO DB STORAGE ==> https://api.panel.conse.app/mongo
üó∫Ô∏è MAFIA API ROUTE ==> https://api.mafia.conse.app/
üì° SWAGGER DOC ==> https://api.panel.conse.app/swagger/
üõ¢Ô∏è ADMINER PANEL ==> https://adminer.conse.app
üõéÔ∏è JENKINS PANEL ==> https://jenkins.conse.app
‚õµ PORTAINER PANEL ==> https://portainer.conse.app
üè¶ STRIPE WEBHOOK ENDPOINT ==> https://api.panel.stripewh.conse.app
ü§ñ X BOT ==> https://api.xbot.conse.app
üóûÔ∏è PANEL AND XCORD ERROR LOGS ==> https://api.panel.conse.app/logs
üóÇÔ∏è PANEL ASSETS FOLDER ==> https://api.panel.conse.app/assets
üéôÔ∏è HOSTED ON ==> Digitalocean
```

### üóÉÔ∏è Directory and Structure Explained

> both `mafia` and `panel` services inside `core` are just different binaries which are sharing a same `Cargo.toml` setup.

* `core`: hyper, actix web HTTP and actix WS servers.
    * `stripewh`: stripe webhook listener for checkout events.
    * `xbot`: X bot for twitter tasks verification.
    * `xcord`: discord bot to broadcast new twitter task defined by admin into a discord channel and role assginement based on user points.
    * `panel`: user, dev and admin dashboard panel APIs with actix web and actix WS server.
    * `mafia`: mafia game APIs
        * `controllers`: in-game async controllers related to hyper server.
        * `routers`: in-game API routers related to hyper server.
        * `schemas`: in-game mongodb schemas related to hyper server.
* `infra`: all infrastructure and devops configs.
* `errors`: gem possible errors handler
* `jobs`: gem crontab jobs
* `logs`: gem log files generated by conse panel and other parts of the app.
* `migrations`: diesel postgres sql files
* `scripts`: deployment scripts
* `test`: gem test codes like admin and dev password generator script

## üìò Docs

* [Engines](https://github.com/wildonion/gem/wiki/Engines)

* [Crypto ID](https://github.com/wildonion/gem/wiki/Crypto-ID)

* [Reveal Role](https://github.com/wildonion/gem/wiki/Reveal-Role)

* [TLPS](https://github.com/wildonion/gem/wiki/TLPs)

## üõ†Ô∏è Development Setup

> you can download runtime crashing error logs throught the address `https://api.panel.conse.app/logs` also after setting up the `portainer`, each container logs can be downloaded inside the panel, also makre sure that you've installed the following packages on **MacOS M1**:

```bash
brew tap cossacklabs/tap
brew install openjdk
brew install pkg-config
brew install openssl
brew install diesel
brew link --force openssl
brew install libpq && brew link --force libpq
brew install graphviz
cargo clean
```
then run:

```bash
# üß™ Test Conse Hyper Server
cargo test --bin mafia
# üèÉ Run Conse Hyper Server
cargo run --bin mafia #---> cargo build --bin mafia --release
# üèÉüèΩ‚Äç‚ôÄÔ∏è Run Conse Actix Panel Server
cargo run --bin panel #---> cargo build --bin panel --release
# üèÉüèø Run Conse Test Codes
cargo run --bin contest
```
    
## üöÄ Production Setup

> before going for production, make make sure that you have the `conse.app` domain and the following subdomains are enabled in DNS panel and is pointing to the machine where the `gem` services codes are hosted on, note that for every new (sub)domain inside the VPS there must be a new nginx config file and a new ssl certificate inside the `infra/docker/nginx` folder related to that (sub)domain name which can be setup by running `renew.sh` on every changes to the nginx config file like hosting new codes, services or adding a new domain to the VPS.

```bash
conse.app #---> this main domain is related to the home UI of the app
api.mafia.conse.app #---> points to the conse mafia hyper APIs
api.panel.conse.app #----> points to the conse actix APIs
panel.conse.app #---> points to the panel UI
notif.panel.conse.app #---> points to the websocket push notification server APIs
adminer.conse.app #---> points to the adminer UI
jenkins.conse.app #---> points to the jenkins UI
portainer.conse.app #---> points to the portainer UI
api.panel.stripewh.conse.app #---> stripe webhook endpoint to receive checkout events
api.xbot.conse.app #---> twitter bot to verify twitter tasks 
```

> keep in mind that multiple domains can point to a same VPS which their ssl-s and routes can be setup by nginx also multiple (sub)domains of different domains can point to multiple VPS-es which can be setup inside the DNS panel of those domains like the following:

**DNS records of conse.app domain**

```
Type	    Hostname	               Value	          TTL (seconds)	
A	    conse.app              directs to 64.226.71.201	     3600
A	    api.mafia.conse.app   	   directs to 68.183.137.151     3600 
A	    panel.conse.app    	   directs to 68.183.201.134     3600 
```
**DNS records of wildonion.io domain**

```
Type	    Hostname	               Value	          TTL (seconds)	
A	    wildonion.io           directs to 64.226.71.201	     3600
A	    api.wildonion.app      directs to 68.183.137.154     3600 
A	    admin.wildonion.app    directs to 68.183.201.129     3600 
```
in the above records `wildonion.io` and `conse.app` are pointing to a same VPS but their (sub)domains are pointing to different VPS-es.

finally run the followings: 

```bash
# -----------------------
# ---- read/write access
sudo chmod +x /root && sudo chown -R www-data:www-data /root && sudo chmod -R 777 /root
sudo gpasswd -a www-data root && sudo chmod g+x /root && sudo -u www-data stat /root
sudo chown -R root:root /root && sudo chmod -R 777 /root
sudo chown -R www-data:www-data . && sudo chmod +x /root
sudo chown -R root:root . && sudo chmod -R 777 . 
sudo chmod +x /root && sudo chmod +x /root/gem && sudo chmod +x /root/gem/infra && sudo chmod +x /root/gem/infra/assets && cd scripts
# ---------------
# ---- setup VPS
./setup.sh
# ---------------
# ---- deploy containers
./redeploy.sh
# ---------------
# ---- renew nginx 
./renew.sh
```
    
## ü™ü Schemas and ERDs

> Note that to regenerate the ERD from the postgres database just run ```sqlant postgresql://postgres:<PASSWORD>@localhost/conse > infra/panel.uml && java -jar infra/plantuml.jar infra/panel.uml```.

### ü•™ Conse Panel Postgres ERD Schema

<p align="center">
    <img src="https://github.com/wildonion/gem/blob/master/infra/panel.png">
</p>

### üç¢ Conse Mafia Mongodb ERD Schema

<p align="center">
    <img src="https://github.com/wildonion/gem/blob/master/infra/conse.schema.PNG">
</p>

### üñºÔ∏è [Conse Panel](https://github.com/wildonion/gem/tree/master/core/panel) Push Notif Architecture Diagram

<p align="center">
    <img src="https://github.com/wildonion/gem/blob/master/infra/arch.jpg">
</p>

## üßê WrapUps 

* basically if you want to execute an sql file into a database you can run the following commands:
    - step 1: ```bash docker cp run.sql postgres:run.sql```
    - step 2: ```bash docker exec -it postgres psql -U postgres -d conse -f /run.sql```

* front-end can access the image of an event through the address `https://api.panel.conse.app/assets/images/events/{image_path}` like so: `https://api.panel.conse.app/assets/images/events/event64c93cc7d19645f57fd9f98d-img1692289627686439.jpg` and banner of a user through the address `https://api.panel.conse.app/assets/images/avatars/{image_path}` like so: `https://api.panel.conse.app/assets/images/avatars/avatar12-img1692289627686439.jpg` and `https://api.panel.conse.app/assets/images/banners/banner12-img1692289627686439.jpg`

* we must mount the `assets` directory from the `conse-panel-pg` and `conse-panel-mongo` containers into the host then into the `nginx` container and finally load the assets inside the `api.panel.conse.app.conf` file from `/etc/nginx/assets/` path, by doing the following, any changes made in the `/app/assets` directory of the conse panel containers will be reflected in the `$(pwd)/assets/` directory on the host and because this same host directory is also mounted to the nginx container, changes will also be reflected in the `/etc/nginx/assets` directory of the nginx container:
```bash
# mount from conse panel containers into host: 
... -v $(pwd)/assets/:/app/assets ...
# mount from host into the nginx container 
... -v $(pwd)/assets/:/etc/nginx/assets ...
```

* based on the last wrapup the `assets` directory can be accessible through the `https://api.panel.conse.app/assets/` address.

* the logic flow of an HTTP API body should be as the following:

> make sure that you're passing the JWT into the request header, you've defined the request body strucutre and storage (diesel, mongodb or redis) schemas. 

```rust

#[post("/a/sexy/route/{sexy-param}/{another-sexy-param-id}")]
async fn api(
        req: HttpRequest, app_storage: 
        storage: web::Data<Option<Arc<Storage>>>,
        req_body: web::Json<ReqBody>,
        a_sexy_param: web::Path<(String, i32)>
    ) -> PanelHttpResponse{


    /* extracting storage objects (none async redis, redis async, redis pubsub conn, postgres and mongodb) */
    // ...

    /* extracting required roles */
    // ...

    /* matching over extracted storage object */
    // ...
        
        /* passport checking over extracted roles */
        // ...
            
            /* redis rate limit checker */ 
            // ...

                /* signature verification process */
                // ...

                    /* balance checking */
                    // ...
                    
                        /* api body and code flow responses */ 
                        // ...

}
```
